<html lang="en">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="resources/js/jquery-1.8.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="resources/css/w3.css">
    <link rel="stylesheet" type="text/css" href="resources/css/font-awesome.min.css">
    <title>Calendar</title>
    <style>
        div {
            border: solid 1px blue;
        }
        .cal_event {
            border: solid 1px red;
            position: absolute;
        }
        .cal_header {
            display: inline-block;
        }
        .cal_header_col {
            float: left;
            text-align: center;
            
        }
        .cal_header_left_nav, .cal_header_right_nav {
            
            position:absolute;
        }
        .cal_header_nav_disable {
            border: solid 1px cyan;
        }
        .cal_header_nav_enable{
            background: cyan;
        }
        .cal_data {
            display: inline-block;
            border:solid 1px red;
            width:100%;
        }
        .cal_data_col {
            border: solid 1px yellow;
            position: relative;
            float: left;
        }
    </style>
</head>
<body>
    <div id="scheduler_here" style='width:100%'>
		<div class="cal_navline">
		</div>
		<div class="cal_header" ></div>
		<div class="cal_data" ></div>
        
	</div>
    <script>
        var cal_hours = ['8AM','9AM','10AM','11AM','12PM', '1PM','2PM','3PM','4PM','5PM','6PM', '7PM','8PM','9PM'];
        var cal_data_cols_JSON;
        var cal_data_cols;
        var cal_data_display; // contains only show data_cols
        var cal_timeWidth = 50;
        var cal_timeHeight = 44;
        var cal_headerHeight = 22;
        var cal_dataWidth = 0;
        var cal_dataRemainingWidth = 0;
        var cal_header_nav_width = 30;
        var cal_start_hour = 8;
        var cal_data_col_min_width = 300;
        var cal_data_col_display = 0;   // store number data col display
        var cal_data_col_start_ind = 0;
        
        //TODO: Add current time Line and move Calendar to current time
        $(function () {
            // testing data
            cal_data_cols_JSON = '['
                    +'{"Kelly": [{"eventName":"Kelly1", "startHour": 10, "startMinute":30, "endHour": 13, "endMinute": 15},'
                    +'{"eventName": "event2", "startHour": 13, "startMinute":30, "endHour": 15, "endMinute": 15},'
                    +'{"eventName": "event3", "startHour": 8, "startMinute":30, "endHour": 9, "endMinute": 15}]},'
            +'{"David": [{"eventName":"event1", "startHour": 10, "startMinute":30, "endHour": 13, "endMinute": 15},'
                    +'{"eventName": "event2", "startHour": 10, "startMinute":30, "endHour": 13, "endMinute": 15},'
                    +'{"eventName": "event3", "startHour": 10, "startMinute":30, "endHour": 13, "endMinute": 15}]},'
            +'{"Lynx": [{"eventName":"event1", "startHour": 10, "startMinute":30, "endHour": 13, "endMinute": 15},'
                    +'{"eventName": "event2", "startHour": 10, "startMinute":30, "endHour": 13, "endMinute": 15},'
                    +'{"eventName": "event3", "startHour": 10, "startMinute":30, "endHour": 13, "endMinute": 15}]},'
            +'{"Nancy": [{"eventName":"event1", "startHour": 10, "startMinute":30, "endHour": 13, "endMinute": 15},'
                    +'{"eventName": "event2", "startHour": 10, "startMinute":30, "endHour": 13, "endMinute": 15},'
                    +'{"eventName": "event3", "startHour": 10, "startMinute":30, "endHour": 13, "endMinute": 15}]}'
                +']';
            cal_data_cols = JSON.parse(cal_data_cols_JSON);
            
            fillCalendar();
        });
        // function be called at the end of resize
        var resizeTimer;
		$(window).on('resize', function(e) {
		  clearTimeout(resizeTimer);
		  resizeTimer = setTimeout(function() {
			  fillCalendar();
		  }, 250);
		});
        function fillCalendar(){
            var w = $(window).width();
            // cal number of data column display
            var dataWidth = w - cal_timeWidth;
            cal_data_col_display = Math.floor( dataWidth / cal_data_col_min_width );
            cal_data_col_display = Math.min( cal_data_cols.length, cal_data_col_display);
            cal_dataWidth = Math.floor( dataWidth / cal_data_col_display )-2;
            // cal remaining width to fix data col gap
            cal_dataRemainingWidth = dataWidth - cal_dataWidth * ( cal_data_col_display - 1);
            // get all display info
            cal_data_display = [];
            $(cal_data_cols).each( function(index, value) {
                if( index >= cal_data_col_start_ind && index < cal_data_col_start_ind + cal_data_col_display) {
                    cal_data_display.push(value);
                }
            });
            
            $('.cal_data, .cal_header').css("width", w); 
            $('.cal_data, .cal_header').html("");
            addHeader();
            addTime();
            
            addColumn();
            addEvent();
        }
        function addHeader() {
            var header = document.createElement('div');
            $(header).addClass('cal_header');
            var timeDiv = document.createElement('div');
            $(timeDiv).addClass('cal_header_col');
            $(timeDiv).css({"width":cal_timeWidth, "height":cal_headerHeight});
            $(timeDiv).html("&nbsp;");
            $(header).append(timeDiv);
            $(cal_data_display).each( function(index, value) {
                var colDiv = document.createElement('div');
                $(colDiv).attr("id","cal_header_col_"+index);
                $(colDiv).addClass('cal_header_col');
                $(colDiv).css({"width":cal_dataWidth, "height":cal_headerHeight});
                $(colDiv).text(Object.keys(value));
                $(header).append(colDiv);
            });
            // Left Nav Btn
            var cal_header_left_nav = document.createElement('div');
            $(cal_header_left_nav).addClass('cal_header_left_nav'); $(cal_header_left_nav).css({"width":cal_header_nav_width,"height":cal_headerHeight,"left":cal_timeWidth});
            if( cal_data_col_start_ind > 0) {
                // Enable btn
                $(cal_header_left_nav).addClass("cal_header_nav_enable");
                $(cal_header_left_nav).on("click", function() {
                    cal_data_col_start_ind -= 1;
                    fillCalendar();
                });
            }
            else {
                // Disable btn
                $(cal_header_left_nav).addClass("cal_header_nav_disable");
            }
            $(header).append(cal_header_left_nav);
            
            // Right Nav Btn
            var cal_header_right_nav = document.createElement('div');
            $(cal_header_right_nav).addClass('cal_header_right_nav'); $(cal_header_right_nav).css({"width":cal_header_nav_width,"height":cal_headerHeight,"right":"0px"});
            if( cal_data_col_start_ind + cal_data_col_display < cal_data_cols.length) {
                // Enable btn
                $(cal_header_right_nav).addClass("cal_header_nav_enable");
                $(cal_header_right_nav).on("click", function() {
                    cal_data_col_start_ind += 1;
                    fillCalendar();
                });
            }
            else {
                // Disable btn
                $(cal_header_right_nav).addClass("cal_header_nav_disable");
            }
                
            $(header).append(cal_header_right_nav);
            
            $('.cal_header').append(header);
        }
        function addTime() {
            var timeDiv = document.createElement('div');
            $(timeDiv).addClass('cal_time cal_data_col');
            $(timeDiv).css({"width":cal_timeWidth, "height":cal_timeHeight*cal_hours.length});
            $(cal_hours).each( function(index,value) {
                var timeBlockDiv = document.createElement('div');
                $(timeBlockDiv).css("height",cal_timeHeight);
                $(timeBlockDiv).text(value);
                $(timeDiv).append(timeBlockDiv);
            });
            $('.cal_data').append(timeDiv);
        }
        function addColumn() {
            var separateHeight = cal_timeHeight/2;
            $(cal_data_display).each( function(index, value) {
                var colDiv = document.createElement('div');
                $(colDiv).attr("id","cal_data_col_"+index);
                $(colDiv).addClass('cal_data_col');
                $(colDiv).css({"width":cal_dataWidth, "height":cal_timeHeight*cal_hours.length});
                $(cal_hours).each( function(index,value) {
                    var timeBlockDiv = document.createElement('div');
                    var timeBlockDiv1 = document.createElement('div');
                    $(timeBlockDiv).css("height",separateHeight);
                    $(timeBlockDiv1).css("height",separateHeight);
                    $(colDiv).append(timeBlockDiv);
                    $(colDiv).append(timeBlockDiv1);
                });
                $('.cal_data').append(colDiv);
                
            });
            // fix data col gap
            $('.cal_data_col').last().css("width",cal_dataRemainingWidth-2);
        }
        // Limitation: cut off all out range event
        function addEvent( ) {
            $(cal_data_display).each( function(personIndex, personEvents) {
                $(personEvents[Object.keys(personEvents)]).each( function( eventIndex, eventValue) {
                    console.log(personIndex + '' + eventIndex); 
                    var startTime = new Date(0,0,0,eventValue['startHour'],eventValue['startMinute'],0);
                    var endTime = new Date(0,0,0,eventValue['endHour'],eventValue['endMinute'],0);
                    var event = document.createElement('div');
                    $(event).addClass('cal_event'); $(event).css({"width":"100%","height":getEventHeight(startTime,endTime),"top":getEventTop(startTime)});
                    $(event).html(eventValue['eventName']);

                    $('#cal_data_col_'+personIndex).append(event);
                });
            });
            
        }
        /* Helper functions */
        function getEventTop(startTime) {
            var px = (startTime.getHours() - cal_start_hour) + startTime.getMinutes()/60;
            return px*cal_timeHeight;
        }
        function getEventHeight( startTime, endTime) {
            var px = (endTime.getHours() - startTime.getHours()) + (endTime.getMinutes() - startTime.getMinutes())/60;
            return px*cal_timeHeight;
        }
        
    </script>
</body>
</html>